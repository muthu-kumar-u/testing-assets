<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SSE Face Log Test</title>
  </head>
  <body>
    <h1>Face Log Upload + SSE Test</h1>

    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="startSSE()">Start SSE & Upload</button>

    <pre id="output"></pre>

    <!-- CDN for fetch-event-source -->
    <script type="module">
      import {
        fetchEventSource,
        EventStreamContentType,
      } from "https://cdn.skypack.dev/@microsoft/fetch-event-source";

      const token = ""; // auth tokens
      let formData = null;
      let sseReady = false;
      let controller = null;

      class RetriableError extends Error {}
      class FatalError extends Error {}

      async function startSSE() {
        const fileInput = document.getElementById("imageInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select an image.");
          return;
        }

        formData = new FormData();
        formData.append("image", file);
        sseReady = false;
        controller = new AbortController();

        log("ðŸ”Œ Connecting to SSE...");

        try {
          await fetchEventSource("" // open stream, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            signal: controller.signal,
            async onopen(response) {
              if (
                response.ok &&
                response.headers
                  .get("content-type")
                  ?.includes(EventStreamContentType)
              ) {
                log("âœ… SSE connection opened");
                return; // all good
              } else if (
                response.status >= 400 &&
                response.status < 500 &&
                response.status !== 429
              ) {
                throw new FatalError("Client error: " + response.status);
              } else {
                throw new RetriableError("Server error: " + response.status);
              }
            },
            onmessage(msg) {
              try {
                const data = JSON.parse(msg.data);
                log("ðŸ“¡ Event received:\n" + JSON.stringify(data, null, 2));

                if (data.event === "FatalError") {
                  throw new FatalError("Server sent fatal error");
                }

                if (data.code === 200 && data.event === "ready" && !sseReady) {
                  sseReady = true;
                  log("ðŸŸ¢ Ready signal received. Uploading image...");
                  uploadImageFile();
                }

                if (data.event === "done" || data.final === true) {
                  log("âœ… Final result received. Closing stream.");
                  controller.abort();
                }
              } catch (err) {
                log("âŒ Error parsing SSE message: " + err.message);
              }
            },
            onclose() {
              log("ðŸ” Server closed connection. Retrying...");
              throw new RetriableError();
            },
            onerror(err) {
              if (err instanceof FatalError) {
                log("âŒ Fatal error: " + err.message);
                throw err; // stop retries
              }
              log("âš ï¸ Retriable error: " + err.message);
              // Let fetchEventSource retry
            },
          });
        } catch (err) {
          log("âŒ SSE terminated: " + err.message);
        }
      }

      async function uploadImageFile() {
        try {
          const response = await fetch("" // start proccess,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: formData,
            }
          );

          if (!response.ok) {
            throw new Error("failed: " + response.status);
          }

        } catch (err) {
          log("âŒ error: " + err.message);
        }
      }

      function log(message) {
        const output = document.getElementById("output");
        output.textContent += message + "\n";
      }

      window.startSSE = startSSE;
    </script>
  </body>
</html>
